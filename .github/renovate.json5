{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "extends": [
    "config:recommended",
    "github>truecharts/public//.github/renovate/main.json5"
  ],
  "timezone": "America/Chicago",
  "schedule": [
    "* 22-23,0-5 * * *"
  ],
  "packageRules": [
    {
      "matchPackageNames": [
        "ghcr.io/siderolabs/kubelet",
        "ghcr.io/siderolabs/installer",
        "registry.k8s.io/kubectl"
      ],
      "groupName": "Sidero Labs updates",
      "dependencyDashboardApproval": true,
      "automerge": false
    },
    {
      "matchPackageNames": [
        "getmeili/meilisearch"
      ],
      "groupName": "Meilisearch updates",
      "dependencyDashboardApproval": true,
      "matchUpdateTypes": [
        "major",
        "minor",
        "patch"
      ],
      "description": "Require manual approval for all Meilisearch updates due to potential breaking changes in minor versions"
    },
    {
      "matchDatasources": [
        "docker"
      ],
      "matchPackageNames": [
        "ghcr.io/karakeep-app/karakeep"
      ],
      "allowedVersions": "release",
      "description": "Always use the 'release' tag for Karakeep main image"
    },
    {
      "matchDatasources": [
        "helm"
      ],
      "matchPackageNames": [
        "rss-bridge",
        "rsshub"
      ],
      "groupName": "RSS applications auto-updates",
      "automerge": true,
      "matchUpdateTypes": [
        "major",
        "minor",
        "patch"
      ],
      "description": "Auto-update rss-bridge and rsshub applications including major versions"
    },
    {
      "matchDatasources": [
        "custom.karakeep-meilisearch",
        "custom.karakeep-chrome"
      ],
      "groupName": "Karakeep upstream dependencies",
      "dependencyDashboardApproval": true,
      "description": "Track meilisearch and chrome versions from upstream Karakeep repository"
    },
    {
      "groupName": "all other dependencies",
      "groupSlug": "all-minor-patch",
      "matchUpdateTypes": [
        "minor",
        "patch"
      ],
      "matchPackageNames": [
        "/.*/",
        "!ghcr.io/siderolabs/kubelet",
        "!ghcr.io/siderolabs/installer",
        "!getmeili/meilisearch",
        "!ghcr.io/karakeep-app/karakeep",
        "!rss-bridge",
        "!rsshub",
        "!karakeep-meilisearch",
        "!karakeep-chrome"
      ]
    }
  ],
  "customManagers": [
    {
      "customType": "regex",
      "fileMatch": [
        "^clusters/.*/karakeep/.*\\.ya?ml$"
      ],
      "matchStrings": [
        "# karakeep-upstream-meilisearch: (?<currentValue>.*)"
      ],
      "depNameTemplate": "karakeep-meilisearch",
      "datasourceTemplate": "custom.karakeep-meilisearch",
      "versioningTemplate": "loose"
    },
    {
      "customType": "regex",
      "fileMatch": [
        "^clusters/.*/karakeep/.*\\.ya?ml$"
      ],
      "matchStrings": [
        "# karakeep-upstream-chrome: (?<currentValue>.*)"
      ],
      "depNameTemplate": "karakeep-chrome",
      "datasourceTemplate": "custom.karakeep-chrome",
      "versioningTemplate": "loose"
    }
  ],
  "customDatasources": {
    "karakeep-meilisearch": {
      "defaultRegistryUrlTemplate": "https://raw.githubusercontent.com/karakeep-app/karakeep/main/kubernetes/meilisearch-deployment.yaml",
      "format": "plain",
      "transformTemplates": [
        "($match := /image: getmeili\\/meilisearch:(.+)/; {\"releases\": [{\"version\": $match.groups[0]}]})"
      ]
    },
    "karakeep-chrome": {
      "defaultRegistryUrlTemplate": "https://raw.githubusercontent.com/karakeep-app/karakeep/main/kubernetes/chrome-deployment.yaml", 
      "format": "plain",
      "transformTemplates": [
        "($match := /image: gcr\\.io\\/zenika-hub\\/alpine-chrome:(.+)/; {\"releases\": [{\"version\": $match.groups[0]}]})"
      ]
    }
  }
}
