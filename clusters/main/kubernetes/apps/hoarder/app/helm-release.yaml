apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
    name: hoarder
    namespace: hoarder
spec:
    interval: 15m
    chart:
        spec:
            chart: app-template
            version: 15.4.15
            sourceRef:
                kind: HelmRepository
                name: truecharts
                namespace: flux-system
    releaseName: hoarder
    values:
        TZ: US/Central
        release_name: hoarder

        # Keep hoarder/karakeep environment variables
        hoarder:
            NEXTAUTH_URL: https://h.${DOMAIN_0}
            NEXTAUTH_SECRET: ${HOARDER_NEXTAUTH_SECRET}
            MEILI_MASTER_KEY: ${HOARDER_MEILI_MASTER_KEY}
            NEXT_PUBLIC_SECRET: ${HOARDER_NEXT_PUBLIC_SECRET}
            DATA_DIR: "/data"
            MEILI_ADDR: "http://localhost:7700"
            BROWSER_WEB_URL: "http://localhost:9222"
            OPENAI_API_KEY: ${OPENAI_API_KEY}
            CRAWLER_VIDEO_DOWNLOAD: "true"
            # OIDC Configuration
            OAUTH_CLIENT_ID: "hoarder"
            OAUTH_CLIENT_SECRET: ${clients_hoarder_client_secret}
            OAUTH_WELLKNOWN_URL: "https://auth.${DOMAIN_0}/.well-known/openid-configuration"
            OAUTH_PROVIDER_NAME: "Authelia"
            # Enable OAuth user registration
            DISABLE_SIGNUPS: "false"
            DISABLE_PASSWORD_AUTH: "true"
            # Allow OAuth account creation and linking
            OAUTH_ALLOW_DANGEROUS_EMAIL_ACCOUNT_LINKING: "true"
            MEILI_ENV: "production"
            MEILI_NO_ANALYTICS: "true"

        # Use karakeep images and versions
        image:
            repository: ghcr.io/karakeep-app/karakeep
            pullPolicy: IfNotPresent
            tag: "0.26.0"
            
        meilisearchImage:
            repository: getmeili/meilisearch
            pullPolicy: IfNotPresent
            tag: "v1.11.1"
            
        chromeImage:
            repository: gcr.io/zenika-hub/alpine-chrome
            pullPolicy: IfNotPresent
            tag: "124"

        securityContext:
            container:
                UMASK: "0022"
                readOnlyRootFilesystem: false
                runAsNonRoot: false
                runAsUser: 0
                runAsGroup: 0

        credentials:
            ${VOLSYNC_BACKUP_MAIN_NAME}:
                accessKey: ${VOLSYNC_BACKUP_MAIN_ACCESSKEY}
                bucket: ${VOLSYNC_BACKUP_MAIN_BUCKET}
                encrKey: ${VOLSYNC_BACKUP_MAIN_ENCRKEY}
                name: ${VOLSYNC_BACKUP_MAIN_NAME}
                path: ""
                secretKey: ${VOLSYNC_BACKUP_MAIN_SECRETKEY}
                type: s3
                url: ${VOLSYNC_BACKUP_MAIN_URL}

        service:
            main:
                ports:
                    main:
                        port: 3000
                        targetPort: 3000

        ingress:
            main:
                enabled: true
                ingressClassName: external
                hosts:
                    - host: h.${DOMAIN_0}
                      paths:
                          - path: /
                integrations:
                    certManager:
                        certificateIssuer: domain-0-le-prod
                        enabled: true
                    homepage:
                        enabled: false
                    traefik:
                        allowCors: false
                        enabled: false
                        entrypoints:
                            - websecure

        workload:
            main:
                podSpec:
                    containers:
                        main:
                            primary: true
                            ports:
                                - containerPort: 3000
                                  name: main
                            env:
                                MEILI_ADDR: "{{ .Values.hoarder.MEILI_ADDR }}"
                                BROWSER_WEB_URL: "{{ .Values.hoarder.BROWSER_WEB_URL }}"
                                NEXTAUTH_URL: "{{ .Values.hoarder.NEXTAUTH_URL }}"
                                DATA_DIR: "{{ .Values.hoarder.DATA_DIR }}"
                                OPENAI_API_KEY: "{{ .Values.hoarder.OPENAI_API_KEY }}"
                                HOARDER_VERSION: "{{ .Values.image.tag }}"
                                NEXTAUTH_SECRET: "{{ .Values.hoarder.NEXTAUTH_SECRET }}"
                                MEILI_MASTER_KEY: "{{ .Values.hoarder.MEILI_MASTER_KEY }}"
                                NEXT_PUBLIC_SECRET: "{{ .Values.hoarder.NEXT_PUBLIC_SECRET }}"
                                CRAWLER_VIDEO_DOWNLOAD: "{{ .Values.hoarder.CRAWLER_VIDEO_DOWNLOAD }}"
                                # OIDC Configuration
                                OAUTH_CLIENT_ID: "{{ .Values.hoarder.OAUTH_CLIENT_ID }}"
                                OAUTH_CLIENT_SECRET: "{{ .Values.hoarder.OAUTH_CLIENT_SECRET }}"
                                OAUTH_WELLKNOWN_URL: "{{ .Values.hoarder.OAUTH_WELLKNOWN_URL }}"
                                OAUTH_PROVIDER_NAME: "{{ .Values.hoarder.OAUTH_PROVIDER_NAME }}"
                                # Enable OAuth user registration
                                DISABLE_SIGNUPS: "{{ .Values.hoarder.DISABLE_SIGNUPS }}"
                                DISABLE_PASSWORD_AUTH: "{{ .Values.hoarder.DISABLE_PASSWORD_AUTH }}"
                                # Allow OAuth account creation and linking
                                OAUTH_ALLOW_DANGEROUS_EMAIL_ACCOUNT_LINKING: "{{ .Values.hoarder.OAUTH_ALLOW_DANGEROUS_EMAIL_ACCOUNT_LINKING }}"
                                # OAuth provider type and user creation
                                OAUTH_PROVIDER_TYPE: "{{ .Values.hoarder.OAUTH_PROVIDER_TYPE }}"
                            probes:
                                liveness:
                                    enabled: true
                                    type: http
                                    path: /api/health
                                readiness:
                                    enabled: true
                                    type: http
                                    path: /api/health
                                startup:
                                    enabled: true
                                    type: http
                                    path: /api/health
                        chrome:
                            enabled: true
                            imageSelector: chromeImage
                            ports:
                                - containerPort: 9222
                                  name: main
                            command:
                                - chromium-browser
                                - --headless
                                - --no-sandbox
                                - --disable-gpu
                                - --disable-dev-shm-usage
                                - --remote-debugging-address=0.0.0.0
                                - --remote-debugging-port=9222
                                - --hide-scrollbars
                            probes:
                                liveness:
                                    enabled: true
                                    type: tcp
                                    port: 9222
                                readiness:
                                    enabled: true
                                    type: tcp
                                    port: 9222
                                startup:
                                    enabled: true
                                    type: tcp
                                    port: 9222
                        meilisearch:
                            enabled: true
                            imageSelector: meilisearchImage
                            ports:
                                - containerPort: 7700
                                  name: main
                            env:
                                MEILI_NO_ANALYTICS: "{{ .Values.hoarder.MEILI_NO_ANALYTICS }}"
                                MEILI_ENV: "{{ .Values.hoarder.MEILI_ENV }}"
                                MEILI_MASTER_KEY: "{{ .Values.hoarder.MEILI_MASTER_KEY }}"
                            probes:
                                liveness:
                                    enabled: true
                                    type: tcp
                                    port: 7700
                                readiness:
                                    enabled: true
                                    type: tcp
                                    port: 7700
                                startup:
                                    enabled: true
                                    type: tcp
                                    port: 7700
                replicas: 1
                
        persistence:
            data:
                enabled: true
                targetSelector:
                    main:
                        main:
                            mountPath: "/data"
                volsync:
                    - credentials: ${VOLSYNC_BACKUP_MAIN_NAME}
                      dest:
                        enabled: true
                      name: ${VOLSYNC_BACKUP_MAIN_NAME}
                      src:
                        enabled: true
                      type: restic
            meili-data:
                enabled: true
                targetSelector:
                    main:
                        meilisearch:
                            mountPath: "/meili_data"
                volsync:
                    - credentials: ${VOLSYNC_BACKUP_MAIN_NAME}
                      dest:
                        enabled: true
                      name: ${VOLSYNC_BACKUP_MAIN_NAME}
                      src:
                        enabled: true
                      type: restic
