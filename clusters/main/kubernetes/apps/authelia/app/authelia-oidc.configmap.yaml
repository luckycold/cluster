apiVersion: v1
kind: ConfigMap
metadata:
  name: authelia-configfile
  namespace: authelia
data:
  configuration.yaml: |
    session:
      cookies:
        - domain: ${DOMAIN_0}
          authelia_url: https://auth.${DOMAIN_0}
    
    authentication_backend:
      ldap:
        implementation: lldap
        address: ldap://lldap-ldap.lldap.svc.cluster.local:3890
        base_dn: ${LLDAP_LDAP_BASE_DN}
        user: uid=manager,ou=people,${LLDAP_LDAP_BASE_DN}
        password: ${LLDAP_LDAP_USER_PASS}
    
    access_control:
      default_policy: deny
      rules:
        - domain:
            - '*.${DOMAIN_0}'
          domain_regex: []
          networks:
            - 192.168.0.0/16
          policy: bypass
          resources: []
          subject: []
        - domain:
            - '*.${DOMAIN_0}'
          domain_regex: []
          networks: []
          policy: bypass
          resources:
            - ^/api([/?].*)?$
            - ^/identity.*$
            - ^/triggers.*$
            - ^/meshagents.*$
            - ^/meshsettings.*$
            - ^/agent.*$
            - ^/control.*$
            - ^/meshrelay.*$
            - ^/wl.*$
          subject: []
        - domain:
            - '*.${DOMAIN_2}'
          domain_regex: []
          networks: []
          policy: bypass
          resources:
            - ^/api([/?].*)?$
            - ^/identity.*$
            - ^/triggers.*$
            - ^/meshagents.*$
            - ^/meshsettings.*$
            - ^/agent.*$
            - ^/control.*$
            - ^/meshrelay.*$
            - ^/wl.*$
          subject: []
        - domain:
            - pass.${DOMAIN_0}
          domain_regex: []
          networks: []
          policy: two_factor
          resources:
            - ^*/admin.*$
          subject:
            - group:admin
        - domain:
            - mc-cs.${DOMAIN_0}
          domain_regex: []
          networks: []
          policy: two_factor
          subject:
            - group:user
        - domain:
            - pass.${DOMAIN_0}
          domain_regex: []
          networks: []
          policy: deny
          resources:
            - ^*/admin.*$
          subject: []
        - domain:
            - pass.${DOMAIN_0}
          domain_regex: []
          networks: []
          policy: bypass
          resources: []
          subject: []
        - domain:
            - changeme.${DOMAIN_0}
          domain_regex: []
          networks: []
          policy: two_factor
          resources: []
          subject:
            - group:user
        - domain:
            - ${DOMAIN_2}
            - '*.${DOMAIN_2}'
          domain_regex: []
          networks: []
          policy: two_factor
          resources: []
          subject:
            - group:admin
            - group:trusted
            - group:user
        - domain:
            - ${DOMAIN_0}
            - '*.${DOMAIN_0}'
          domain_regex: []
          networks: []
          policy: two_factor
          resources: []
          subject:
            - group:admin
            - group:trusted
            - group:user
    
    notifier:
      smtp:
        address: submission://${SMTP_SERVER}:587
        password: ${SMTP_PASSWORD}
        sender: ${ADMIN_EMAIL}
        username: ${ADMIN_EMAIL}
        tls:
          server_name: ${SMTP_SERVER}
          minimum_version: TLS1.2
          skip_verify: false
    
    # OIDC Identity Provider Configuration
    identity_providers:
      oidc:
        hmac_secret: {{ secret "/config/secrets/hmac_secret" }}
        jwks:
          - key: |
              {{ secret "/config/secrets/jwks_key.pem" | mindent 10 "|" | msquote }}

        claims_policies:
          with_email:
            id_token:
              - "email"
              - "email_verified"
              - "alt_emails"
              - "preferred_username"
              - "name"
        authorization_policies:
          matrix:
            default_policy: 'deny'
            rules:
              - policy: 'two_factor'
                subject: 'group:user'
              - policy: 'two_factor'
                subject: 'group:admin'
              - policy: 'two_factor'
                subject: 'group:trusted'
        clients:
          - client_id: 'matrix'
            client_name: 'Matrix Server'
            client_secret: {{ secret "/config/secrets/clients_matrix_client_secret" }}
            public: false
            authorization_policy: 'matrix'
            require_pkce: true
            pkce_challenge_method: 'S256'
            redirect_uris:
              - 'https://matrix.${DOMAIN_0}/_synapse/client/oidc/callback'
            scopes:
              - 'openid'
              - 'profile'
              - 'email'
            response_types:
              - 'code'
            grant_types:
              - 'authorization_code'
          - client_id: 'generic-test'
            client_name: 'Generic Test Client'
            client_secret: {{ secret "/config/secrets/clients_generic_client_secret" }}
            public: false
            authorization_policy: 'matrix'
            require_pkce: true
            pkce_challenge_method: 'S256'
            redirect_uris:
              - 'https://oidcdebugger.com/debug'
              - 'http://localhost:8080/callback'
              - 'https://oauth.pstmn.io/v1/callback'
            scopes:
              - 'openid'
              - 'profile'
              - 'email'
            response_types:
              - 'code'
            grant_types:
              - 'authorization_code'
          - client_id: 'audiobookshelf'
            client_name: 'Audiobookshelf'
            client_secret: {{ secret "/config/secrets/clients_audiobookshelf_client_secret" }}
            public: false
            authorization_policy: 'matrix'
            require_pkce: true
            pkce_challenge_method: 'S256'
            redirect_uris:
              - 'https://books.${DOMAIN_0}/audiobookshelf/auth/openid/callback'
              - 'https://books.${DOMAIN_0}/audiobookshelf/auth/openid/mobile-redirect'
            scopes:
              - 'openid'
              - 'profile'
              - 'email'
              - 'groups'
            response_types:
              - 'code'
            grant_types:
              - 'authorization_code'
          - client_id: 'immich'
            client_name: 'Immich'
            client_secret: {{ secret "/config/secrets/clients_immich_client_secret" }}
            public: false
            authorization_policy: 'matrix'
            require_pkce: true
            pkce_challenge_method: 'S256'
            redirect_uris:
              - 'app.immich:///oauth-callback'
              - 'https://${DOMAIN_2}/auth/login'
              - 'https://${DOMAIN_2}/user-settings'
            scopes:
              - 'openid'
              - 'profile'
              - 'email'
            response_types:
              - 'code'
            grant_types:
              - 'authorization_code'
          - client_id: 'romm'
            client_name: 'RomM'
            # client_secret not needed for public clients
            public: true
            authorization_policy: 'matrix'
            require_pkce: false
            grant_types:
              - 'authorization_code'
            redirect_uris:
              - 'https://romm.${DOMAIN_0}/api/oauth/openid'
            claims_policy: 'with_email'
            scopes:
              - 'openid'
              - 'email'
              - 'profile'
            userinfo_signed_response_alg: 'none'
            token_endpoint_auth_method: 'none'
