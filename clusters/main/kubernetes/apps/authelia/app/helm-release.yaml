apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
    name: authelia
    namespace: authelia
spec:
    interval: 15m
    chart:
        spec:
            chart: authelia
            version: 29.7.0
            sourceRef:
                kind: HelmRepository
                name: truecharts
                namespace: flux-system
    releaseName: authelia
    values:
        authelia:
          session:
            cookies:
              - domain: ${DOMAIN_0}
                authelia_url: https://auth.${DOMAIN_0}
          authentication_backend:
                file:
                    enabled: false
                ldap:
                    enabled: true
                    implementation: lldap
                    url: ldap://lldap-ldap.lldap.svc.cluster.local:3890
                    base_dn: ${LLDAP_LDAP_BASE_DN}
                    user: uid=manager,ou=people,${LLDAP_LDAP_BASE_DN}
                    password: ${LLDAP_LDAP_USER_PASS}
          access_control:
                default_policy: deny
                rules:
                    - domain:
                        - '*.${DOMAIN_0}'
                      domain_regex: []
                      networks:
                        - 192.168.0.0/16
                      policy: bypass
                      resources: []
                      subject: []
                    - domain:
                        - '*.${DOMAIN_0}'
                      domain_regex: []
                      networks: []
                      policy: bypass
                      resources:
                        - ^/api([/?].*)?$
                        - ^/identity.*$
                        - ^/triggers.*$
                        - ^/meshagents.*$
                        - ^/meshsettings.*$
                        - ^/agent.*$
                        - ^/control.*$
                        - ^/meshrelay.*$
                        - ^/wl.*$
                      subject: []
                    - domain:
                        - pass.${DOMAIN_0}
                      domain_regex: []
                      networks: []
                      policy: two_factor
                      resources:
                        - ^*/admin.*$
                      subject:
                        - group:admin
                    - domain:
                        - mc-cs.${DOMAIN_0}
                      domain_regex: []
                      networks: []
                      policy: two_factor
                      subject:
                        - group:user
                    - domain:
                        - pass.${DOMAIN_0}
                      domain_regex: []
                      networks: []
                      policy: deny
                      resources:
                        - ^*/admin.*$
                      subject: []
                    - domain:
                        - pass.${DOMAIN_0}
                      domain_regex: []
                      networks: []
                      policy: bypass
                      resources: []
                      subject: []
                    - domain:
                        - changeme.${DOMAIN_0}
                      domain_regex: []
                      networks: []
                      policy: two_factor
                      resources: []
                      subject:
                        - group:user
                    - domain:
                        - ${DOMAIN_0}
                        - '*.${DOMAIN_0}'
                      domain_regex: []
                      networks: []
                      policy: two_factor
                      resources: []
                      subject:
                        - group:admin
          notifier:
              smtp:
                  address: submission://${SMTP_SERVER}:587
                  password: ${SMTP_PASSWORD}
                  port: 587
                  sender: ${ADMIN_EMAIL}
                  username: ${ADMIN_EMAIL}
                  tls:
                    server_name: ${SMTP_SERVER}
                    minimum_version: TLS1.2
                    skip_verify: false
        TZ: US/Central
        workload:
          main:
            replicas: 2
            podSpec:
              containers:
                main:
                  env:
                    # Update the following secrets with your own values
                    AUTHELIA_SESSION_SECRET: ${VOLSYNC_BACKUP_MAIN_ENCRKEY}
                    AUTHELIA_IDENTITY_VALIDATION_RESET_PASSWORD_JWT_SECRET: ${VOLSYNC_BACKUP_MAIN_ENCRKEY}
                    AUTHELIA_STORAGE_ENCRYPTION_KEY: ${VOLSYNC_BACKUP_MAIN_ENCRKEY}
        cnpg:
            main:
                mode: standalone
                password: ${AUTHELIA_CNPG_PASSWORD}
                backups:
                    credentials: ${VOLSYNC_BACKUP_MAIN_NAME}
                    enabled: true
        credentials:
            ${VOLSYNC_BACKUP_MAIN_NAME}:
                accessKey: ${VOLSYNC_BACKUP_MAIN_ACCESSKEY}
                bucket: ${VOLSYNC_BACKUP_MAIN_BUCKET}
                encrKey: ${VOLSYNC_BACKUP_MAIN_ENCRKEY}
                name: ${VOLSYNC_BACKUP_MAIN_NAME}
                path: ""
                secretKey: ${VOLSYNC_BACKUP_MAIN_SECRETKEY}
                type: s3
                url: ${VOLSYNC_BACKUP_MAIN_URL}
        ingress:
            main:
                enabled: true
                ingressClassName: external
                hosts:
                    - host: auth.${DOMAIN_0}
                      paths:
                integrations:
                    certManager:
                        certificateIssuer: domain-0-le-prod
                        enabled: true
                    homepage:
                        enabled: false
        release_name: authelia
        service:
            main:
                loadBalancerIP: ${AUTHELIA_IP}
                type: LoadBalancer
